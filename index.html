<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unofficial SwitchCraft Chat Viewer</title>
    <link rel="shortcut icon" type="image/x-icon" href="icon.ico"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font: 13px BlinkMacSystemFont, -apple-system, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", "Helvetica", "Arial", sans-serif }
        .chat { list-style-type: none; margin: 0; padding: 0; word-wrap: break-word;}
        .chat p { padding: 5px 10px; }
        .chat p:nth-child(odd) { background: #eee; }
        .chat { margin-bottom: 40px; }

        .footer {
            position: fixed;
            left: 0;
            bottom: 0;
            width: 100%;
            background-color: #e0e0e0;
            color: black;
            padding: 4px;
            clear: both;
        }

        /*.container {
            display: grid;
            grid-column-gap: 50px;
            grid-row-gap: 50px;

            grid-template-areas:
                    'main main main menu'
        }*/

        /*.chat { grid-area: main; overflow: scroll;}

        .sidebar { grid-area: menu ; }*/

    </style>

    <script>if (typeof module === 'object') {window.module = module; module = undefined;}</script>
    <script src="js/jquery.min.js"></script>
    <script src="js/moment.min.js"></script>
    <script src="js/linkify.min.js"></script>
    <script src="js/linkify-jquery.min.js"></script>
    <script src="js/linkify-html.min.js"></script>
    <script>
        var enableHTMLformatting = false;
        function escape(message){
            if(!enableHTMLformatting) {
                $("div.escape").text(message);
                return $("<div>").text(message).html();
            }
            return message;
        }
        function addLine(data){
            var fTimestamp;
            if(data.timestamp){
                var date = new Date(data.timestamp * 1000);
                fTimestamp = moment(date).format("HH:mm")
            }
            var message;
            if(data.type === "message"){
                console.log(data.player+"> "+data.message);
                message="<b>"+data.player+"</b> <a style='color: #555555'>"+fTimestamp+"</a><br>"+escape(data.message);
            }else if(data.type === "death"){
                console.log(data.message);
                message="ðŸ’€ <i style='color: #424242'>"+escape(data.message)+"</i> <a style='color: #555555'>"+fTimestamp+"</a>";
            }else if(data.type === "login") {
                console.log(data.player + " " + data.message);
                if (data.message === "joined") {
                    message = "ðŸ‘¤ <b style='color: #1b5e20'>" + data.player + " " + escape(data.message) + "</b> <a style='color: #555555'>" + fTimestamp + "</a>";
                } else {
                    message = "ðŸ‘¤ <b style='color: #f44336'>" + data.player + " " + escape(data.message) + "</b> <a style='color: #555555'>" + fTimestamp + "</a>";
                }
            }else if(data.type === "console_message"){
                console.log("CLCONSOLE> " + data.message);
                message = "ðŸ–¥ <b>CLConsole</b> <a style='color: #555555'>"+fTimestamp+"</a><br>"+escape(data.message);
            }else if(data.type === "subscribe" && data.event === "chat"){
                console.log("Ready");
                start();
            }else if(data.message){
                console.log(data.message);
                message = data.message;
            }
            if(message) {
                var list = document.getElementById('chat');
                var entry = document.createElement('p');
                entry.innerHTML = linkifyHtml(message);
                entry.class = "chat";
                list.appendChild(entry);
                window.scrollTo(0, document.body.scrollHeight);
            }
        }
        function start(){
            var request = new XMLHttpRequest();
            request.open('GET', "https://pi.ale32bit.me");
            request.responseType = 'text';
            request.onload = function() {
                var loading = document.getElementById('loadingtext');
                loading.parentNode.removeChild(loading);
                var data = JSON.parse(request.response).reverse();
                for(var k in data){
                    var v = data[k];
                    addLine(v);
                }
            };
            request.send();
        }

        function HTMLCheck(h){
            enableHTMLformatting = h.checked;
            if(h.checked){
                console.log("Oh no");
                return;
            }
            console.log("You're safe now");
        }
    </script>

    <script>
        var ws;
        function startWS() {
            ws = new WebSocket("wss://pi.ale32bit.me");

            ws.addEventListener("message", function (event) {
                var data = JSON.parse(event.data);
                addLine(data);
            });

            ws.addEventListener("open", function () {
                ws.send(JSON.stringify({type: "subscribe", event: "chat"}));
                ws.send(JSON.stringify({type: "subscribe", event: "console_message"}));
                addLine({message: "<b>Connected</b>"});
            });

            ws.addEventListener("close", function (event) {
                console.log("Closed");
                addLine({message: "<b>Connection closed</b>"});
                addLine({message: "<b>Attempting to reconnect...</b>"});
                console.log(event);
                console.log(event.reason);
                setTimeout(startWS,3000)
            });

            ws.addEventListener("error", function (err) {
                console.log(err);
                addLine({
                    message: "Error",
                });
                addLine({message: "<b>Attempting to reconnect...</b>"});
                setTimeout(startWS,3000)
            });
        }
        startWS();
    </script>
    <script>if (window.module) module = window.module;</script>
</head>
<body>
    <div class="container" style="width: 100%">
    <div id="escape" style="display: none;"></div>
    <div class="chat" id="chat">
        <p><b>Welcome to SwitchCraft chat viewer!</b> <i>Coded by Ale32bit!</i></p>
        <h1 id="loadingtext" style="text-align: center;">Loading latest 100 messages...</h1>
    </div>
    <!--<div class="sidebar"><p>hi</p></div>-->

    <footer class="footer">
        <p style="float: right;"><a href="https://github.com/Ale32bit/SCChat" target="_blank">Source Code</a> | &copy; 2018 Ale32bit</p>
        <label>
            <input type="checkbox" onclick="HTMLCheck(this);" title="Warning: Enabling HTML formatting may lead to regrets."> HTML Formatting
        </label>
    </footer>
    </div>
</body>
</html>